<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afiliado Zap√£o - Ganhe Comiss√£o</title>
    <link rel="icon" type="image/png" href="/images/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: rgba(26, 26, 35, 0.9);
            --text-primary: #ffffff;
            --text-secondary: #8a8a9a;
            --border-color: rgba(212, 175, 55, 0.3);
            --gold: #D4AF37;
            --gradient-gold: linear-gradient(135deg, #FFD700, #D4AF37, #B8860B);
            --green: #22c55e;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0f;
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
            text-align: center;
        }

        .logo {
            width: 80px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        /* Steps Logic */
        .step {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: var(--gold);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        h2 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .input-group {
            text-align: left;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--gold);
            font-size: 0.9rem;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 1.1rem;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: var(--gradient-gold);
            color: #000;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:active {
            transform: scale(0.98);
        }

        .back-link {
            display: block;
            margin-top: 30px;
            color: var(--text-secondary);
            text-decoration: none;
        }

        /* Success State */
        .link-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed var(--gold);
            margin-bottom: 15px;
            word-break: break-all;
            color: var(--gold);
            font-weight: bold;
            font-family: monospace;
        }
    </style>
</head>

<body>

    <div class="container">
        <a href="/zapao-da-sorte"><img src="/images/logo.png" alt="Zap√£o" class="logo"></a>

        <div class="card">

            <!-- STEP 1: Phone Check -->
            <div id="step1" class="step active">
                <h1>üéÅ Pr√™mios por Indica√ß√£o</h1>
                <p>Indique amigos e concorra a pr√™mios exclusivos sem custo nenhum!</p>

                <div class="input-group">
                    <label>Seu WhatsApp</label>
                    <input type="tel" id="checkPhone" placeholder="(11) 99999-9999" maxlength="15"
                        oninput="formatPhone(this)">
                </div>

                <button onclick="checkStatus()">Gerar meu Link</button>
            </div>

            <!-- STEP 2: Registration (If new) -->
            <div id="step2" class="step">
                <h2>üìù Complete seu Cadastro</h2>
                <p>Precisamos dos seus dados para pagar suas comiss√µes.</p>

                <div class="input-group">
                    <label>Nome Completo</label>
                    <input type="text" id="regName" placeholder="Seu nome">
                </div>

                <div class="input-group">
                    <label>Chave Pix (Para receber)</label>
                    <input type="text" id="regPix" placeholder="CPF, Email ou Telefone">
                </div>

                <button onclick="register()">Confirmar e Gerar Link</button>
                <button onclick="backToStep1()"
                    style="background:transparent; color:#888; margin-top:10px;">Voltar</button>
            </div>

            <!-- STEP 3: Success -->
            <div id="step3" class="step">
                <h1 style="color:var(--green)">‚úÖ Link Gerado!</h1>
                <p>Copie e envie para seus amigos. Boa sorte!</p>

                <div class="link-box" id="finalLink">...</div>

                <button onclick="copyLink()">üìã Copiar Link</button>
                <div id="copyMsg" style="color:var(--green); margin-top:10px; display:none;">Copiado com sucesso!</div>
            </div>

            <!-- Loading -->
            <div id="loading" class="step">
                <p>Processando...</p>
            </div>

        </div>

        <a href="/zapao-da-sorte" class="back-link">‚¨Ö Voltar para o Sorteio</a>
    </div>

    <script>
        let currentPhone = '';

        function formatPhone(input) {
            let v = input.value.replace(/\D/g, '');
            v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
            v = v.replace(/(\d)(\d{4})$/, '$1-$2');
            input.value = v;
        }

        function showStep(id) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function checkStatus() {
            const phoneInput = document.getElementById('checkPhone');
            const cleanPhone = phoneInput.value.replace(/\D/g, '');

            if (cleanPhone.length < 10) {
                alert('Digite um telefone v√°lido!');
                return;
            }

            currentPhone = cleanPhone;
            showStep('loading');

            try {
                const res = await fetch(`/api/affiliates/check/${cleanPhone}`);
                const data = await res.json();

                if (data.found) {
                    // Update stored Name/Pix if available (optional enhancement)
                    // Just show link
                    showLink(cleanPhone);
                } else {
                    // Need registration
                    showStep('step2');
                }

            } catch (e) {
                alert('Erro ao verificar. Tente novamente.');
                showStep('step1');
            }
        }

        function backToStep1() {
            showStep('step1');
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const pix = document.getElementById('regPix').value.trim();

            if (!name || !pix) {
                alert('Preencha todos os campos!');
                return;
            }

            showStep('loading');

            try {
                const res = await fetch('/api/affiliates/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: currentPhone,
                        name: name,
                        pix_key: pix
                    })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                showLink(currentPhone);

            } catch (e) {
                alert(e.message || 'Erro ao cadastrar.');
                showStep('step2');
            }
        }

        function showLink(phone) {
            const link = `${window.location.origin}/zapao-da-sorte?ref=${phone}`;
            document.getElementById('finalLink').textContent = link;
            showStep('step3');
        }

        function copyLink() {
            const text = document.getElementById('finalLink').textContent;
            navigator.clipboard.writeText(text).then(() => {
                const msg = document.getElementById('copyMsg');
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
            });
        }
    </script>
</body>

</html>