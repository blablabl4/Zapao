<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria de Afiliados - TVZap√£o</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --bg-card: #151515;
            --gold: #d4af37;
            --gold-dark: #b8942e;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --border: #2a2a2a;
            --success: #4ade80;
            --warning: #fbbf24;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        header h1 {
            color: var(--gold);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold);
        }

        .tab-btn.active {
            background: var(--gold);
            color: #000;
            border-color: var(--gold);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .draw-selector {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .draw-selector label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .draw-selector select {
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            min-width: 200px;
        }

        .draw-info {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
        }

        .draw-info span {
            color: var(--text-secondary);
        }

        .draw-info strong {
            color: var(--gold);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gold);
        }

        .stat-card .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-container {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .table-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            font-size: 1.1rem;
            color: var(--gold);
        }

        .refresh-btn {
            background: var(--gold);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: var(--gold-dark);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(212, 175, 55, 0.1);
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        td {
            font-size: 0.9rem;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .rank {
            font-weight: 700;
            color: var(--gold);
        }

        .name {
            font-weight: 500;
        }

        .phone {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .number {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .number.highlight {
            color: var(--success);
        }

        .revenue {
            color: var(--success);
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Medal colors */
        .rank-1 {
            color: #ffd700;
        }

        .rank-2 {
            color: #c0c0c0;
        }

        .rank-3 {
            color: #cd7f32;
        }

        /* Sub-affiliate form */
        .sub-form-container {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            margin: 0 auto;
        }

        .sub-form-container h2 {
            color: var(--gold);
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .generate-btn {
            width: 100%;
            background: var(--gold);
            color: #000;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .generate-btn:hover {
            background: var(--gold-dark);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .link-result {
            margin-top: 20px;
            padding: 15px;
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid var(--success);
            border-radius: 8px;
            display: none;
        }

        .link-result.show {
            display: block;
        }

        .link-result p {
            color: var(--success);
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .link-box {
            display: flex;
            gap: 10px;
        }

        .link-box input {
            flex: 1;
            background: var(--bg-dark);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .copy-btn {
            background: var(--success);
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .my-subs {
            margin-top: 30px;
        }

        .my-subs h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .sub-item {
            background: var(--bg-dark);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sub-item .sub-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .sub-item .sub-stats {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .sub-item .sub-link {
            color: var(--gold);
            font-size: 0.8rem;
            word-break: break-all;
        }

        /* Accordion styles */
        .parent-row {
            cursor: pointer;
        }

        .parent-row:hover {
            background: rgba(212, 175, 55, 0.1) !important;
        }

        .expand-icon {
            display: inline-block;
            transition: transform 0.2s;
            margin-right: 5px;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .sub-row {
            background: rgba(255, 255, 255, 0.02);
            display: none;
        }

        .sub-row.show {
            display: table-row;
        }

        .sub-row td {
            padding-left: 40px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border-bottom: 1px dashed var(--border);
        }

        /* IDSR Footer */
        .idsr-footer {
            margin-top: 40px;
            padding: 15px;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border-top: 1px solid var(--border);
        }

        .idsr-footer a {
            color: var(--text-secondary);
            text-decoration: none;
        }

        .idsr-footer a:hover {
            color: var(--gold);
        }

        .idsr-footer strong {
            color: var(--gold);
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .draw-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .draw-info {
                margin-left: 0;
                justify-content: center;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 600px;
                font-size: 0.8rem;
            }

            th,
            td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }

            .rank {
                font-size: 0.9rem;
            }

            .name {
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .phone {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üìä Auditoria de Afiliados</h1>
            <p>Relat√≥rio de desempenho com clientes √∫nicos</p>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn" onclick="switchTab('sublink')">üîó Criar Sub-Link</button>
            <button class="tab-btn active" onclick="switchTab('balance')">üí∞ Meus Ganhos</button>
        </div>

        <!-- Tab 2: Sub-Link -->
        <div id="tab-sublink" class="tab-content" style="text-align: center;">
            <div class="sub-form-container">
                <h2>üîó Criar Sub-Link de Afiliado</h2>
                <p style="color: var(--text-secondary); text-align: center; margin-bottom: 25px;">
                    Crie links personalizados para seus indicados
                </p>

                <div class="form-group">
                    <label>Seu Telefone (Afiliado Principal)</label>
                    <input type="tel" id="parentPhone" placeholder="11999998888" maxlength="11">
                </div>

                <hr style="border: none; border-top: 1px solid var(--border); margin: 20px 0;">
                <p style="color: var(--gold); font-size: 0.9rem; margin-bottom: 15px;">üìù Dados do Sub-Afiliado</p>

                <div class="form-group">
                    <label>Nome do Sub-Afiliado *</label>
                    <input type="text" id="subName" placeholder="Ex: Jo√£o da Padaria">
                </div>

                <div class="form-group">
                    <label>Telefone do Sub-Afiliado *</label>
                    <input type="tel" id="subPhone" placeholder="11988887777" maxlength="11">
                </div>

                <div class="form-group">
                    <label>Chave PIX do Sub-Afiliado (opcional)</label>
                    <input type="text" id="subPix" placeholder="CPF, email ou telefone para pagamento">
                </div>

                <button class="generate-btn" onclick="createSubLink()">Gerar Link</button>

                <div class="link-result" id="linkResult">
                    <p>‚úÖ Link criado com sucesso!</p>
                    <div class="link-box">
                        <input type="text" id="generatedLink" readonly>
                        <button class="copy-btn" onclick="copyLink()">Copiar</button>
                    </div>
                </div>

                <div class="my-subs" id="mySubs">
                    <h3>üìã Meus Sub-Afiliados</h3>
                    <div id="subsList">
                        <p style="color: var(--text-secondary);">Digite seu telefone para ver seus sub-afiliados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Meus Ganhos (Now Default) -->
        <div id="tab-balance" class="tab-content active">
            <div class="sub-form-container">
                <h2>üí∞ Consultar Meus Ganhos</h2>
                <p style="color: var(--text-secondary); text-align: center; margin-bottom: 25px;">
                    Consulte seu saldo dispon√≠vel e desempenho detalhado
                </p>

                <div class="form-group">
                    <label>Seu Telefone</label>
                    <input type="tel" id="balancePhone" placeholder="11999998888" maxlength="11"
                        onkeypress="handleBalanceEnter(event)">
                </div>

                <button class="generate-btn" onclick="checkBalance()">Consultar Saldo</button>

                <div id="balanceResult" style="display:none; margin-top: 30px; animation: fadeIn 0.3s ease;">

                    <!-- BALANCE SUMMARY CARD -->
                    <div id="balanceSummaryCard"
                        style="background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%); border: 1px solid var(--gold); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--gold); margin: 0;">üí∞ Seu Saldo</h3>
                            <span id="affiliateName" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
                        </div>

                        <div
                            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                                <div
                                    style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px;">
                                    Total Acumulado</div>
                                <div id="totalEarned" style="font-size: 1.3rem; font-weight: 700; color: #4ade80;">R$
                                    0,00</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                                <div
                                    style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 5px;">
                                    J√° Pago</div>
                                <div id="totalPaid" style="font-size: 1.3rem; font-weight: 700; color: #f87171;">R$ 0,00
                                </div>
                            </div>
                            <div
                                style="background: rgba(212, 175, 55, 0.2); padding: 15px; border-radius: 8px; border: 1px solid var(--gold);">
                                <div
                                    style="font-size: 0.7rem; color: var(--gold); text-transform: uppercase; margin-bottom: 5px;">
                                    A Receber</div>
                                <div id="availableBalance"
                                    style="font-size: 1.5rem; font-weight: 700; color: var(--gold);">R$ 0,00</div>
                            </div>
                        </div>

                        <div
                            style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; display: flex; justify-content: space-around; font-size: 0.85rem;">
                            <span><span style="color: var(--text-secondary);">üìä Total Tickets:</span> <strong
                                    id="totalTickets">0</strong></span>
                            <span><span style="color: var(--text-secondary);">üë• Clientes:</span> <strong
                                    id="totalClients">0</strong></span>
                        </div>
                    </div>

                    <!-- Details Table - Rifa Atual Only -->
                    <h3
                        style="color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px;">
                        üìã Desempenho na Rifa Atual
                    </h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th style="text-align: center;">Tickets</th>
                                    <th style="text-align: center;">Clientes</th>
                                    <th style="text-align: right;">Comiss√£o L√≠quida</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <footer class="idsr-footer">
            ¬© 2026 IDSR. Todos os direitos reservados. |
            <a href="https://idsr.com.br" target="_blank">Produzido e gerenciado por <strong>IDSR</strong></a>
        </footer>
    </div>

    <script>
        let currentDrawId = null;
        let cachedAffiliates = []; // Store loaded data for balance check

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            if (tab === 'sublink') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tab-sublink').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('tab-balance').classList.add('active');
            }
        }

        function toggleSubs(rank) {
            const icon = document.querySelector(`tr[data-rank="${rank}"] .expand-icon`);
            const subRows = document.querySelectorAll(`tr.sub-row[data-parent="${rank}"]`);

            if (icon) {
                icon.classList.toggle('expanded');
            }

            subRows.forEach(row => row.classList.toggle('show'));
        }

        // Create sub-affiliate link
        async function createSubLink() {
            const parentPhone = document.getElementById('parentPhone').value.replace(/\D/g, '');
            const subName = document.getElementById('subName').value.trim();
            const subPhone = document.getElementById('subPhone').value.replace(/\D/g, '');
            const subPix = document.getElementById('subPix').value.trim();

            if (!parentPhone || parentPhone.length < 10) {
                alert('Digite um telefone v√°lido do afiliado principal');
                return;
            }

            if (!subName) {
                alert('Digite o nome do sub-afiliado');
                return;
            }

            if (!subPhone || subPhone.length < 10) {
                alert('Digite um telefone v√°lido do sub-afiliado');
                return;
            }

            try {
                const res = await fetch('/api/audit/sub-affiliate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parent_phone: parentPhone,
                        sub_name: subName,
                        sub_phone: subPhone,
                        pix_key: subPix || null
                    })
                });

                const data = await res.json();

                if (data.success) {
                    document.getElementById('generatedLink').value = data.sub_affiliate.link;
                    document.getElementById('linkResult').classList.add('show');
                    document.getElementById('subName').value = '';
                    document.getElementById('subPhone').value = '';
                    document.getElementById('subPix').value = '';
                    loadMySubs(parentPhone);
                } else {
                    alert(data.error || 'Erro ao criar link');
                }
            } catch (e) {
                console.error('Error creating sub-link:', e);
                alert('Erro ao criar link. Tente novamente.');
            }
        }

        // Copy link to clipboard
        function copyLink() {
            const input = document.getElementById('generatedLink');
            input.select();
            document.execCommand('copy');
            alert('Link copiado!');
        }

        // Load my sub-affiliates
        async function loadMySubs(phone) {
            if (!phone || phone.length < 10) {
                document.getElementById('subsList').innerHTML = '<p style="color: var(--text-secondary);">Digite seu telefone para ver seus sub-afiliados</p>';
                return;
            }

            try {
                const res = await fetch(`/api/audit/sub-affiliates?parent_phone=${phone}`);
                const data = await res.json();

                if (data.sub_affiliates && data.sub_affiliates.length > 0) {
                    document.getElementById('subsList').innerHTML = data.sub_affiliates.map(sub => `
                        <div class="sub-item">
                            <div>
                                <div class="sub-name">${sub.sub_name}</div>
                                <div class="sub-link">${sub.link}</div>
                            </div>
                            <div class="sub-stats">
                                ${sub.ticket_count} tickets | R$ ${sub.revenue.toFixed(2)}
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('subsList').innerHTML = '<p style="color: var(--text-secondary);">Nenhum sub-afiliado criado ainda</p>';
                }
            } catch (e) {
                console.error('Error loading subs:', e);
            }
        }

        // Auto-load subs when phone is entered
        document.getElementById('parentPhone').addEventListener('blur', function () {
            loadMySubs(this.value.replace(/\D/g, ''));
        });



        function handleBalanceEnter(e) {
            if (e.key === 'Enter') checkBalance();
        }

        async function checkBalance() {
            const phone = document.getElementById('balancePhone').value.replace(/\D/g, '');
            const resultDiv = document.getElementById('balanceResult');
            const detailsTable = document.getElementById('detailsTableBody');

            console.log('[checkBalance] Starting with phone:', phone);

            if (!phone || phone.length < 10) {
                alert('Por favor, digite um telefone v√°lido.');
                return;
            }

            resultDiv.style.display = 'none';
            detailsTable.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Carregando...</td></tr>';
            resultDiv.style.display = 'block';

            try {
                // FIRST: Fetch accumulated balance summary
                console.log('[checkBalance] Fetching balance summary...');
                const balanceRes = await fetch('/api/audit/affiliate-balance?phone=' + phone);
                if (balanceRes.ok) {
                    const balanceData = await balanceRes.json();
                    if (balanceData.success) {
                        // Populate summary card
                        document.getElementById('affiliateName').textContent = balanceData.affiliate.name || '';
                        document.getElementById('totalEarned').textContent = 'R$ ' + balanceData.earnings.total_earned.toFixed(2).replace('.', ',');
                        document.getElementById('totalPaid').textContent = 'R$ ' + balanceData.earnings.total_paid.toFixed(2).replace('.', ',');
                        document.getElementById('availableBalance').textContent = 'R$ ' + balanceData.earnings.available_balance.toFixed(2).replace('.', ',');
                        document.getElementById('totalTickets').textContent = balanceData.earnings.total_tickets || 0;
                        document.getElementById('totalClients').textContent = balanceData.earnings.total_clients || 0;
                        console.log('[checkBalance] Balance summary loaded:', balanceData);
                    }
                } else {
                    console.log('[checkBalance] Balance API error, continuing with draw data only');
                }

                // Get current draw ID from PUBLIC audit history API
                console.log('[checkBalance] Fetching draw history...');
                const historyRes = await fetch('/api/audit/history');
                if (!historyRes.ok) {
                    throw new Error('Erro ao buscar rifas: ' + historyRes.status);
                }
                const historyData = await historyRes.json();

                // Find active draw or use the first one
                var currentDraw = null;
                if (historyData.draws && historyData.draws.length > 0) {
                    currentDraw = historyData.draws.find(function (d) { return d.status === 'ACTIVE'; });
                    if (!currentDraw) {
                        currentDraw = historyData.draws[0]; // Fallback to most recent
                    }
                }

                var currentDrawId = currentDraw ? currentDraw.id : null;
                console.log('[checkBalance] Current draw ID:', currentDrawId);

                if (!currentDrawId) {
                    detailsTable.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#888;">Nenhuma rifa ativa no momento.</td></tr>';
                    return;
                }

                // Fetch affiliates filtered by current draw
                console.log('[checkBalance] Fetching affiliates for draw:', currentDrawId);
                const affRes = await fetch('/api/audit/affiliates?draw_id=' + currentDrawId);
                if (!affRes.ok) {
                    throw new Error('Erro ao buscar afiliados: ' + affRes.status);
                }
                const affData = await affRes.json();
                const affiliates = affData.affiliates || [];
                console.log('[checkBalance] Found affiliates:', affiliates.length);

                // Find the affiliate or sub-affiliate by phone
                let foundAff = affiliates.find(function (a) {
                    const affPhone = (a.phone || '').replace(/\D/g, '');
                    return affPhone === phone;
                });
                let isSubaffiliate = false;
                let parentAff = null;

                // If not found directly, check if phone is a sub-affiliate
                if (!foundAff) {
                    console.log('[checkBalance] Not found as main affiliate, checking sub-affiliates...');
                    // Look through all affiliates' sub_affiliates
                    for (var i = 0; i < affiliates.length; i++) {
                        var aff = affiliates[i];
                        if (aff.sub_affiliates && aff.sub_affiliates.length > 0) {
                            const sub = aff.sub_affiliates.find(function (s) {
                                // Check by sub_code or if we stored sub_phone
                                return s.sub_code && s.sub_code.toLowerCase().includes(phone.slice(-4));
                            });
                            if (sub) {
                                isSubaffiliate = true;
                                parentAff = aff;
                                foundAff = { name: sub.name, isSubRow: true, ticket_count: sub.ticket_count, unique_clients: sub.unique_clients, sub_commission: sub.sub_commission };
                                console.log('[checkBalance] Found as sub-affiliate:', sub.name);
                                break;
                            }
                        }
                    }

                    // Also try the subaffiliate-earnings endpoint
                    if (!foundAff) {
                        try {
                            console.log('[checkBalance] Trying subaffiliate-earnings endpoint...');
                            const subRes = await fetch('/api/audit/subaffiliate-earnings?phone=' + phone);
                            const subData = await subRes.json();
                            if (subData.success && subData.is_subaffiliate) {
                                console.log('[checkBalance] Found via subaffiliate-earnings API');
                                isSubaffiliate = true;
                                const currentComm = subData.current.net_commission || 0;
                                const tickets = subData.current.tickets || 0;
                                const clients = subData.current.unique_clients || 0;

                                // iOS-safe number formatting
                                var commFormatted = 'R$ ' + currentComm.toFixed(2).replace('.', ',');

                                detailsTable.innerHTML =
                                    '<tr>' +
                                    '<td style="font-weight: bold; color: #60a5fa;">' +
                                    'üë§ ' + (subData.sub_affiliate.name || 'Sub-Afiliado') +
                                    '</td>' +
                                    '<td style="text-align: center;">' + tickets + '</td>' +
                                    '<td style="text-align: center; color: #4ade80;">' + clients + '</td>' +
                                    '<td style="text-align: right; color: #4ade80; font-weight: 600;">' +
                                    commFormatted +
                                    '</td>' +
                                    '</tr>';
                                return;
                            }
                        } catch (e) {
                            console.log('[checkBalance] Sub-affiliate check failed:', e.message || e);
                        }
                    }
                }

                if (!foundAff) {
                    console.log('[checkBalance] Phone not found anywhere');
                    detailsTable.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#f87171;">Telefone n√£o encontrado como afiliado ou sub-afiliado nesta rifa.</td></tr>';
                    return;
                }

                console.log('[checkBalance] Building table for:', foundAff.name);

                // Build table HTML
                var tableHtml = '';

                // Padrinho row (self)
                const affTickets = foundAff.ticket_count || 0;
                const affClients = foundAff.unique_clients || 0;
                const affCommission = foundAff.net_commission || foundAff.total_commission || foundAff.sub_commission || 0;

                // iOS-safe number formatting
                var affCommFormatted = 'R$ ' + affCommission.toFixed(2).replace('.', ',');

                tableHtml +=
                    '<tr style="background: rgba(212, 175, 55, 0.1);">' +
                    '<td style="font-weight: bold; color: var(--gold);">' +
                    'üëë ' + (foundAff.name || 'Afiliado') + ' (Voc√™)' +
                    '</td>' +
                    '<td style="text-align: center;">' + affTickets + '</td>' +
                    '<td style="text-align: center; color: #4ade80;">' + affClients + '</td>' +
                    '<td style="text-align: right; color: #4ade80; font-weight: 600;">' +
                    affCommFormatted +
                    '</td>' +
                    '</tr>';

                // Add sub-affiliates rows
                if (foundAff.sub_affiliates && foundAff.sub_affiliates.length > 0) {
                    foundAff.sub_affiliates.forEach(function (sub) {
                        const subComm = sub.sub_commission || 0;
                        var subCommFormatted = 'R$ ' + subComm.toFixed(2).replace('.', ',');

                        tableHtml +=
                            '<tr>' +
                            '<td style="padding-left: 20px; color: #60a5fa;">' +
                            '‚Ü≥ üë§ ' + (sub.name || 'Sub-Afiliado') +
                            '</td>' +
                            '<td style="text-align: center;">' + (sub.ticket_count || 0) + '</td>' +
                            '<td style="text-align: center; color: #4ade80;">' + (sub.unique_clients || 0) + '</td>' +
                            '<td style="text-align: right; color: #60a5fa;">' +
                            subCommFormatted +
                            '</td>' +
                            '</tr>';
                    });
                }

                detailsTable.innerHTML = tableHtml;
                console.log('[checkBalance] Success!');

            } catch (e) {
                console.error('[checkBalance] ERROR:', e);
                console.error('[checkBalance] Error details:', e.message || e);
                console.error('[checkBalance] Error stack:', e.stack || 'No stack');
                detailsTable.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#f87171;">Erro ao buscar dados. Tente novamente.<br><small style="color:#888;font-size:0.8em;">Erro: ' + (e.message || 'Desconhecido') + '</small></td></tr>';
            }
        }

        // Initialize

    </script>
</body>

</html>