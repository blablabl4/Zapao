<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bol√£o do Zap√£o - Mega da Virada 2025</title>

    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="/images/bolao-logo.jpg">
    <link rel="apple-touch-icon" href="/images/bolao-logo.jpg">

    <!-- Open Graph Meta Tags for Social Sharing -->
    <meta property="og:title" content="Bol√£o do Zap√£o - Mega da Virada 2025">
    <meta property="og:description"
        content="Participe do Bol√£o do Zap√£o! Escolha seus n√∫meros da sorte por apenas R$ 20,00 cada. Jogo de 10 dezenas com 100 cotas dispon√≠veis.">
    <meta property="og:image" content="https://tvzapao.com.br/images/bolao-logo.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://tvzapao.com.br/bolao">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Bol√£o do Zap√£o - Mega da Virada 2025">
    <meta name="twitter:description"
        content="Participe do Bol√£o do Zap√£o! Escolha seus n√∫meros da sorte por apenas R$ 20,00 cada.">
    <meta name="twitter:image" content="https://tvzapao.com.br/images/bolao-logo.jpg">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --green: #28a745;
            --yellow: #ffc107;
            --red: #dc3545;
            --dark: #1e1e1e;
            --gold: #FFD700;
        }

        body {
            background-color: #0f2027;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            color: white;
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding-bottom: 50px;
        }

        .header {
            text-align: center;
            padding: 20px 10px;
        }

        .logo {
            max-width: 250px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--gold);
            text-transform: uppercase;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .info-bar {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            margin: 10px auto;
            border-radius: 10px;
            max-width: 90%;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .info-item span {
            color: var(--gold);
            display: block;
            font-size: 1.2rem;
        }

        /* GRID */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        .ticket {
            aspect-ratio: 1;
            background: var(--green);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 900;
            position: relative;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s;
        }

        .ticket:active {
            transform: scale(0.95);
        }

        .ticket.sold,
        .ticket.paid {
            background: var(--red);
            font-size: 0.65rem;
            flex-direction: column;
            cursor: default;
            padding: 3px;
            text-align: center;
        }

        .ticket.sold .ticket-number,
        .ticket.paid .ticket-number {
            font-size: 1rem;
            font-weight: 900;
            line-height: 1;
        }

        .ticket.sold .owner-name,
        .ticket.paid .owner-name {
            font-size: 0.5rem;
            line-height: 1.1;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .ticket.pending {
            background: var(--yellow);
            color: #000;
            animation: pulse 1s infinite;
        }

        .ticket.selected {
            background: #007bff;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.8);
            transform: scale(1.05);
        }

        /* Floating Cart */
        .floating-cart {
            position: fixed;
            bottom: 30px;
            right: 20px;
            background: linear-gradient(135deg, #00E676, #00C853);
            color: #000;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 230, 118, 0.5);
            z-index: 999;
            animation: pulseCart 1.5s infinite;
        }

        .floating-cart.show {
            display: flex;
        }

        @keyframes pulseCart {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(0, 230, 118, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 230, 118, 0);
            }
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .owner-name {
            font-size: 0.6rem;
            margin-top: 2px;
            text-align: center;
            line-height: 1;
            opacity: 0.9;
        }

        @keyframes pulse {
            50% {
                opacity: 0.7;
            }
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: #252525;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #444;
        }

        .modal h2 {
            color: var(--gold);
            margin-top: 0;
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #555;
            background: #111;
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
            /* Fix padding issues */
        }

        .btn-pay {
            background: var(--green);
            color: white;
            border: none;
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-close {
            background: transparent;
            color: #aaa;
            border: none;
            margin-top: 15px;
            cursor: pointer;
        }

        #pixArea {
            display: none;
            margin-top: 20px;
        }

        .pix-code {
            background: white;
            color: black;
            padding: 10px;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.8rem;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>

<body>

    <div class="header">
        <img src="/images/bolao-logo.jpg" alt="Logo" class="logo">
        <div class="game-title" id="gameTitle">Carregando...</div>

        <div class="info-bar">
            <div class="info-item"><span>10</span>Dezenas</div>
            <div class="info-item"><span id="totalCotas">100</span>Cotas</div>
            <div class="info-item"><span id="priceDisplay">R$ 20,00</span>Valor</div>
        </div>
    </div>

    <div class="grid-container" id="grid"></div>

    <!-- Floating Cart Button -->
    <div class="floating-cart" id="floatingCart" onclick="openTermsModal()">
        üõí
        <span class="cart-badge" id="cartBadge">0</span>
    </div>

    <!-- Terms Modal -->
    <div class="modal-overlay" id="termsModal">
        <div class="modal" style="max-height: 90vh; overflow-y: auto;">
            <h2 style="color: var(--gold); margin-bottom: 15px;">üìú Regras do Bol√£o</h2>
            <div
                style="text-align: left; font-size: 0.85rem; line-height: 1.5; color: #ddd; max-height: 50vh; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 15px;">
                <p>‚Ä¢ Cada cota tem o valor de <strong>R$ 20,00</strong>.</p>
                <p>‚Ä¢ Cada bol√£o contar√° com <strong>100 (cem) cotas</strong> no total.</p>
                <p>‚Ä¢ O bol√£o ser√° realizado com aposta de <strong>10 n√∫meros</strong> na Mega da Virada 2025.</p>
                <p>‚Ä¢ Os n√∫meros da aposta ser√£o <strong>gerados automaticamente pela casa lot√©rica</strong>, no momento
                    da realiza√ß√£o da aposta.</p>
                <p>‚Ä¢ Ap√≥s a realiza√ß√£o da aposta, ser√£o divulgados os n√∫meros jogados, bem como a lista com os nomes dos
                    participantes e respectivas cotas, garantindo <strong>total transpar√™ncia</strong> do bol√£o.</p>
                <p>‚Ä¢ As cotas f√≠sicas e os registros oficiais ficar√£o sob a guarda do organizador, exclusivamente para
                    controle, confer√™ncia e presta√ß√£o de contas.</p>
                <p>‚Ä¢ Em caso de premia√ß√£o, <strong>5% do valor total do pr√™mio</strong> ser√° destinado ao organizador,
                    como compensa√ß√£o pela organiza√ß√£o, gest√£o e responsabilidade do bol√£o.</p>
                <p>‚Ä¢ Os <strong>95% restantes</strong> do pr√™mio ser√£o divididos proporcionalmente entre os cotistas, de
                    acordo com a quantidade de cotas adquiridas por cada participante.</p>
                <p style="color: var(--yellow); margin-top: 10px;">‚Ä¢ Ao clicar no link de compra e adquirir a cota, o
                    participante declara estar de acordo com todas as regras acima, n√£o sendo permitidas altera√ß√µes ap√≥s
                    a confirma√ß√£o da participa√ß√£o.</p>
            </div>
            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer;">
                <input type="checkbox" id="acceptTerms" style="width: 20px; height: 20px; accent-color: var(--green);">
                <span style="color: #fff;">Aceito todos os termos acima</span>
            </label>
            <button class="btn-pay" onclick="proceedToCheckout()" id="proceedBtn" disabled
                style="opacity: 0.5;">Continuar</button>
            <button class="btn-close" onclick="closeTermsModal()">Fechar</button>
        </div>
    </div>

    <!-- Modal Checkout -->
    <div class="modal-overlay" id="checkoutModal">
        <div class="modal">
            <h2 id="modalTitle">Reservar N√∫mero</h2>
            <div id="formArea">
                <div class="input-group">
                    <label>Seu WhatsApp</label>
                    <input type="tel" id="phone" class="form-control" placeholder="(11) 99999-9999"
                        onblur="lookupUser()">
                </div>
                <div class="input-group">
                    <label>Nome Completo</label>
                    <input type="text" id="name" class="form-control" placeholder="Jo√£o Silva">
                </div>
                <div class="input-group">
                    <label>CPF</label>
                    <input type="text" id="cpf" class="form-control" placeholder="000.000.000-00">
                </div>
                <button class="btn-pay" onclick="doCheckout()" id="payBtn">Pagar R$ 20,00</button>
            </div>

            <div id="pixArea">
                <h3 style="color:#fff">Pagamento PIX</h3>
                <p style="font-size:0.9rem; color:#ccc">Escaneie o QR Code ou copie o c√≥digo:</p>
                <img id="qrImage" src="" alt="QR Code PIX"
                    style="width: 200px; height: 200px; margin: 10px auto; display: block; border-radius: 10px; background: white; padding: 10px;">
                <div class="pix-code" id="pixCode"></div>
                <button class="btn-pay" onclick="copyPix()">üìã Copiar C√≥digo PIX</button>
                <p style="margin-top:10px; color:var(--yellow); font-size:0.8rem">‚è≥ Aguardando confirma√ß√£o do
                    pagamento...</p>
            </div>

            <button class="btn-close" onclick="closeModal()">Fechar</button>
        </div>
    </div>

    <script>
        let selectedNumbers = [];
        let currentRound = 1;
        let currentPrice = 20.00;

        // Auto-Load
        loadGrid();
        setInterval(loadGrid, 5000); // Auto-refresh every 5s

        function updateCart() {
            const cart = document.getElementById('floatingCart');
            const badge = document.getElementById('cartBadge');
            if (selectedNumbers.length > 0) {
                cart.classList.add('show');
                badge.innerText = selectedNumbers.length;
            } else {
                cart.classList.remove('show');
            }
        }

        function toggleSelection(number) {
            const idx = selectedNumbers.indexOf(number);
            if (idx > -1) {
                selectedNumbers.splice(idx, 1);
            } else {
                selectedNumbers.push(number);
            }
            updateCart();
            // Update visual
            document.querySelectorAll('.ticket').forEach(el => {
                const num = parseInt(el.dataset.number);
                if (selectedNumbers.includes(num)) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }

        function openTermsModal() {
            if (selectedNumbers.length === 0) return;
            document.getElementById('acceptTerms').checked = false;
            document.getElementById('proceedBtn').disabled = true;
            document.getElementById('proceedBtn').style.opacity = '0.5';
            document.getElementById('termsModal').style.display = 'flex';
        }

        function closeTermsModal() {
            document.getElementById('termsModal').style.display = 'none';
        }

        function proceedToCheckout() {
            closeTermsModal();
            openCartModal();
        }

        // Enable/disable proceed button based on checkbox
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('acceptTerms').addEventListener('change', function () {
                const btn = document.getElementById('proceedBtn');
                btn.disabled = !this.checked;
                btn.style.opacity = this.checked ? '1' : '0.5';
            });
        });

        function openCartModal() {
            if (selectedNumbers.length === 0) return;
            const total = (selectedNumbers.length * currentPrice).toFixed(2).replace('.', ',');
            document.getElementById('modalTitle').innerText = `Reservar ${selectedNumbers.length} N√∫mero(s)`;
            document.getElementById('payBtn').innerText = `Pagar R$ ${total}`;
            document.getElementById('formArea').style.display = 'block';
            document.getElementById('pixArea').style.display = 'none';
            document.getElementById('checkoutModal').style.display = 'flex';
        }
        setInterval(loadGrid, 5000); // Auto-refresh every 5s

        async function loadGrid() {
            try {
                const res = await fetch('/api/bolao/grid');
                const data = await res.json();

                currentRound = data.round || 1;
                const price = parseFloat(data.price) || 20.00;
                document.getElementById('gameTitle').innerText = `BOL√ÉO DO ZAP√ÉO - JOGO #${currentRound}`;
                document.getElementById('priceDisplay').innerText = `R$ ${price.toFixed(2).replace('.', ',')}`;

                if (data.grid && data.grid.length > 0) {
                    renderGrid(data.grid);
                } else {
                    // No grid data yet, render empty grid 1-100
                    const emptyGrid = [];
                    for (let i = 1; i <= 100; i++) emptyGrid.push({ number: i, status: 'AVAILABLE', owner: null });
                    renderGrid(emptyGrid);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderGrid(grid) {
            const container = document.getElementById('grid');
            container.innerHTML = '';

            grid.forEach(item => {
                const el = document.createElement('div');
                el.className = `ticket ${item.status.toLowerCase()}`;
                el.dataset.number = item.number;

                if (item.status === 'AVAILABLE') {
                    el.innerText = item.number;
                    if (selectedNumbers.includes(item.number)) el.classList.add('selected');
                    el.onclick = () => toggleSelection(item.number);
                } else if (item.status === 'PENDING') {
                    el.innerText = item.number;
                } else {
                    // PAID - Show number on top, owner below
                    const num = document.createElement('div');
                    num.className = 'ticket-number';
                    num.innerText = item.number;

                    const name = document.createElement('div');
                    name.className = 'owner-name';
                    // item.owner format: "Nome (...1234)"
                    name.innerText = item.owner || 'Vendido';

                    el.appendChild(num);
                    el.appendChild(name);
                }
                container.appendChild(el);
            });
        }

        async function openModal(number) {
            selectedNumber = number;
            document.getElementById('modalTitle').innerText = `Reservar #${number}`;
            document.getElementById('formArea').style.display = 'block';
            document.getElementById('pixArea').style.display = 'none';
            document.getElementById('checkoutModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('checkoutModal').style.display = 'none';
        }

        async function lookupUser() {
            const phone = document.getElementById('phone').value;
            if (phone.length > 8) {
                const res = await fetch(`/api/bolao/lookup/${encodeURIComponent(phone)}`);
                const data = await res.json();
                if (data.found) {
                    document.getElementById('name').value = data.name;
                    document.getElementById('cpf').value = data.cpf || '';
                }
            }
        }

        async function doCheckout() {
            const btn = document.getElementById('payBtn');
            btn.disabled = true;
            btn.innerText = 'Processando...';

            const payload = {
                phone: document.getElementById('phone').value,
                name: document.getElementById('name').value,
                cpf: document.getElementById('cpf').value,
                numbers: selectedNumbers // Send Array
            };

            try {
                const res = await fetch('/api/bolao/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                // Success -> Show PIX
                document.getElementById('formArea').style.display = 'none';
                document.getElementById('pixArea').style.display = 'block';
                document.getElementById('pixCode').innerText = data.qrCode;
                document.getElementById('qrImage').src = 'data:image/png;base64,' + data.qrCodeBase64;

                // Clear selection after successful checkout
                selectedNumbers = [];
                updateCart();

            } catch (e) {
                alert('Erro: ' + e.message);
                btn.disabled = false;
                const total = (selectedNumbers.length * currentPrice).toFixed(2).replace('.', ',');
                btn.innerText = `Pagar R$ ${total}`;
            }
        }

        function copyPix() {
            const code = document.getElementById('pixCode').innerText;
            navigator.clipboard.writeText(code);
            alert('C√≥digo copiado!');
        }

    </script>
</body>

</html>