<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amigos do Zap√£o</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Amigos do Zap√£o Specific Styles */
        :root {
            /* HUB LIGHT THEME */
            --az-primary: #10b981;
            /* Hub Green */
            --az-primary-dark: #059669;
            --az-dark: #f3f4f6;
            /* Light BG */
            --az-card-bg: #ffffff;
            /* White Card */
            --az-text: #1f2937;
            /* Dark Text */
            --az-text-secondary: #4b5563;
            --az-text-muted: #6b7280;
            --az-blur: 10px;
            --az-border: #e5e7eb;

            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-blur: blur(12px);
            --modal-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        body {
            background-color: var(--az-dark);
            color: var(--az-text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* GLASS MORPHISM MODAL OVERRIDES */
        .az-modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .az-modal {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--modal-shadow);
            border-radius: 20px;
            padding: 1.5rem;
            width: 90%;
            max-width: 420px;
            text-align: center;
            position: relative;
            animation: slideUp 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Compact Form Elements */
        .az-form-group {
            margin-bottom: 0.8rem;
            text-align: left;
        }

        .az-form-label {
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
            color: var(--az-text-secondary);
            font-weight: 500;
            display: block;
        }

        .az-form-control {
            width: 100%;
            padding: 10px;
            font-size: 0.95rem;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            background: rgba(255, 255, 255, 0.9);
        }

        .az-form-control:focus {
            outline: none;
            border-color: var(--az-primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Carousel Slot Animation - CSS fallback */
        @keyframes carouselSpin {
            0% {
                transform: translateX(200%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Pop-in animation for cards */
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0) rotate(-180deg);
            }

            60% {
                transform: scale(1.15) rotate(10deg);
            }

            100% {
                opacity: 1;
                transform: scale(1) rotate(0);
            }
        }

        .az-card.pop-in {
            animation: popIn 0.5s ease-out forwards;
        }

        .slot-revealed {
            border: 2px solid var(--az-primary) !important;
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.4);
            color: var(--az-primary);
            font-weight: bold;
        }

        .slot-revealed .az-card-content {
            color: var(--az-primary);
        }

        /* Logo Glow Effect */
        .logo-glow {
            filter: drop-shadow(0 0 20px rgba(0, 230, 118, 0.5)) drop-shadow(0 0 40px rgba(0, 230, 118, 0.3));
        }

        /* Hero / Home View */
        .az-home-view {
            text-align: center;
            padding: 2rem 1rem;
            margin-top: 60px;
            width: 100%;
            display: block;
            /* Toggled via JS */
        }

        .az-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #00E676 0%, #00B0FF 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .az-subtitle {
            color: var(--az-text-muted);
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        /* Cards Container - 5 columns grid */
        .az-cards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            padding: 0 1rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .az-cards-container .az-card {
            width: calc(20% - 0.5rem);
            min-width: 55px;
        }

        @media (max-width: 450px) {
            .az-cards-container {
                gap: 0.3rem;
                max-width: 100%;
            }

            .az-cards-container .az-card {
                width: calc(20% - 0.3rem);
                min-width: 50px;
            }
        }

        .az-card {
            background: var(--az-card-bg);
            border-radius: 8px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            color: var(--az-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        .az-card.blur .az-card-content {
            filter: blur(var(--az-blur));
            opacity: 0.5;
        }

        .az-card.reveal .az-card-content {
            filter: blur(0);
            opacity: 1;
            transform: scale(1.1);
        }

        .az-card.reveal {
            border: 2px solid var(--az-primary);
        }

        /* Loading shimmer for blur state */
        .az-card.blur::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Action Button (FIXED UNIFORMITY) */
        .az-btn-main {
            background: linear-gradient(135deg, #00E676 0%, #00C853 100%);
            color: #000;
            border: none;
            padding: 0 1.5rem;
            min-height: 52px;
            /* Fixed height for ALL buttons */
            height: 52px;
            /* Enforce height */
            font-size: 1rem;
            /* Uniform font size */
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            /* Flex centering for <a> and <button> */
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            text-align: center;
            white-space: nowrap;
            /* NO TEXT WRAP */
            width: 100%;
            /* Default full width in stacked contexts */
            position: relative;
            z-index: 10;
        }

        .az-btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 230, 118, 0.6);
        }

        .az-btn-main:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }

        /* Reveal Grid */
        .az-reveal-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.8rem;
            width: 100%;
            max-width: 380px;
            /* Wider for better spacing */
            margin: 0 auto;
        }

        @media (max-width: 380px) {
            .az-reveal-grid {
                gap: 0.5rem;
            }
        }

        /* Modal Overlay - Blocking (Only for Alerts/Lookups) */
        .az-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 20000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .az-modal {
            background: #ffffff;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 380px;
            height: auto;
            min-height: 200px;
            overflow: visible !important;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            animation: slideUp 0.3s ease-out;
            margin: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .az-modal-content {
            padding: 2.5rem 2rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            border-radius: 20px;
            text-align: center;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .az-modal h2 {
            margin-top: 0;
            color: var(--az-text);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--az-text-muted);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--az-border);
            background: #fff;
            color: var(--az-text);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--az-primary);
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.85rem;
            color: #888;
            margin-top: 1rem;
        }

        .checkbox-group input {
            margin-top: 3px;
        }

        .az-success-msg {
            display: none;
            text-align: center;
            margin-top: 1rem;
        }

        .promo-badge {
            background: #E91E63;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: bold;
            margin-bottom: 1rem;
            display: inline-block;
        }

        /* --- Full Screen Stories View (No Modal) --- */
        .stories-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--az-dark);
            /* Opaque background */
            z-index: 10000;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stories-wrapper {
            width: 100%;
            max-width: 480px;
            /* Limit max width for desktop feel */
            height: 100%;
            position: relative;
            overflow: hidden;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            /* Shadow on sides for desktop */
        }

        .stories-track {
            display: flex;
            width: 300%;
            /* 3 slides */
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .story-slide {
            width: 33.333333%;
            height: 100%;
            flex-shrink: 0;
            overflow-y: auto;
            position: relative;
            /* BETTER SPACING / DISTRIBUTION */
            padding: 1rem 1.5rem 6rem 1.5rem;
            /* Huge bottom padding for arrow space */
            box-sizing: border-box;
            background: #1a1a1a;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            /* Header Top, Content Middle, Footer Bottom */
        }

        .story-header {
            margin-top: 4.5rem;
            margin-bottom: 1rem;
            width: 100%;
            text-align: center;
            flex-shrink: 0;
        }

        .story-content-area {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            position: relative;
            /* Content is free to scroll if needed, but flex centered by default */
        }

        /* Nav Buttons */
        .story-nav-btn {
            position: absolute;
            bottom: 30px;
            /* Fixed at bottom right */
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            border: none;
            font-size: 1.8rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            display: none;
            /* Hidden by default */
        }

        .story-nav-btn.visible {
            display: flex;
            background: var(--az-primary);
            color: #000;
            box-shadow: 0 0 25px rgba(0, 230, 118, 0.8);
            animation: pulseBtn 1.5s infinite;
        }

        @keyframes pulseBtn {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(0, 230, 118, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 230, 118, 0);
            }
        }

        .story-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2.5rem;
            line-height: 1;
            z-index: 60;
            cursor: pointer;
            opacity: 0.7;
        }

        .story-badge {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #00E676 0%, #00C853 100%);
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
    </style>
</head>

<body>
    <!-- Home View (Initial) -->
    <div id="home-view" class="az-home-view">
        <!-- Logo with Glow Effect -->
        <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
            <img src="/images/amigos-logo-new.png" alt="Amigos do Zap√£o" class="logo-glow"
                style="height: 160px; display: block;">
        </div>
        <div id="promoBadgeContainer"></div>
        <p class="az-subtitle" style="margin-bottom: 1.5rem;">Resgate seu n√∫mero da sorte di√°rio gratuitamente !</p>
        <!-- Cards Area -->
        <div class="az-cards-container" id="cardsContainer">
            <div class="az-card">
                <div class="az-card-content">??</div>
            </div>
            <div class="az-card">
                <div class="az-card-content">??</div>
            </div>
            <div class="az-card">
                <div class="az-card-content">??</div>
            </div>
            <div class="az-card">
                <div class="az-card-content">??</div>
            </div>
            <div class="az-card">
                <div class="az-card-content">??</div>
            </div>
        </div>
        <!-- Initial Buttons -->
        <div
            style="display: flex; flex-direction: column; gap: 0.8rem; align-items: center; width: 100%; max-width: 280px; margin: 0.5rem auto 0;">
            <button class="az-btn-main" id="generateBtn" onclick="startFlow()" style="width: 100%;">Resgatar N√∫mero
            </button>
            <button class="az-btn-main az-btn-secondary" id="lookupBtn" onclick="openLookupModal()"
                style="width: 100%;">Consultar N√∫meros
            </button>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div class="az-modal-overlay" id="alertModal">
        <div class="az-modal" style="text-align: center; max-width: 350px;">
            <div class="az-modal-content">
                <h2 id="alertTitle" style="color: var(--az-primary);">Aten√ß√£o</h2>
                <p id="alertMessage" style="color: #ccc; margin: 1rem 0;"></p>
                <button class="az-btn-main" onclick="closeAlertModal()" style="width: 100%;">OK </button>
            </div>
        </div>
    </div>

    <!-- Lookup Modal -->
    <div class="az-modal-overlay" id="lookupModal">
        <div class="az-modal">
            <div class="az-modal-content">
                <h2>Consultar N√∫meros</h2>
                <div class="form-group"><label>Seu WhatsApp (com DDD)</label><input type="tel" id="lookupPhoneModal"
                        class="form-control" placeholder="(11) 99999-9999" oninput="maskPhone(this)"></div>
                <button class="az-btn-main" onclick="doLookup()" style="width: 100%; margin-top: 1rem;">Buscar </button>
                <div id="lookupResultModal" style="margin-top: 1.5rem;"></div>
                <button onclick="closeLookupModal()" class="az-btn-main az-btn-secondary"
                    style="width: 100%; margin-top: 1rem;">Voltar ao In√≠cio </button>
            </div>
        </div>
    </div>

    <!-- STORIES VIEW (Replcae Modal, Full Screen) -->
    <div class="stories-view" id="storiesView">
        <div class="stories-wrapper">
            <!-- Close -->
            <button class="story-close" onclick="closeStories()">√ó</button>
            <!-- NEXT ARROW (Fixed Bottom Right) -->
            <button class="story-nav-btn" id="storyNextBtn" onclick="nextStory()">‚ùØ</button>

            <div class="stories-track" id="storiesTrack">
                <!-- SLIDE 1: Form (Previously Slide 2) -->
                <div class="story-slide" id="slide2">
                    <div class="story-badge">1</div>
                    <div class="story-header" style="margin-top: 3.5rem; margin-bottom: 0.5rem;">
                        <h2 class="az-title" style="font-size: 1.5rem; margin-bottom: 0.2rem;">Seus Dados</h2>
                        <p style="color: #aaa; margin: 0; font-size: 0.85rem;">Preencha para gerar n√∫meros</p>
                    </div>
                    <div class="story-content-area" style="display: block; width: 100%; padding: 0 1.5rem;">
                        <form id="claimFormStories" onsubmit="submitClaimStep2(event)" style="text-align: left;">

                            <!-- Compact Fields -->
                            <div class="az-form-group">
                                <label class="az-form-label">WhatsApp (com DDD)</label>
                                <input type="tel" id="phone" class="az-form-control" style="width: 100%;" required
                                    placeholder="(11) 99999-9999" oninput="maskPhone(this)"
                                    onblur="checkExistingUser(this.value)">
                            </div>

                            <div class="az-form-group">
                                <label class="az-form-label">Nome Completo</label>
                                <input type="text" id="name" class="az-form-control" style="width: 100%;" required
                                    minlength="3" onblur="this.value = capitalizeName(this.value)">
                            </div>

                            <div class="az-form-group">
                                <label class="az-form-label">CEP (Obrigat√≥rio)</label>
                                <input type="tel" id="cep" class="az-form-control" style="width: 100%;" required
                                    placeholder="00000-000" maxlength="9" oninput="maskCEP(this)">
                            </div>

                            <div class="az-form-group">
                                <label class="az-form-label">J√° compartilhou?</label>
                                <select id="sharedStatus" class="az-form-control" style="width: 100%;" required>
                                    <option value="">Selecione...</option>
                                    <option value="yes">Sim, j√° compartilhei</option>
                                    <option value="no">Vou compartilhar agora</option>
                                </select>
                            </div>

                            <div class="checkbox-group" style="margin-top: 0.5rem;">
                                <input type="checkbox" id="lgpdConsent" required>
                                <label for="lgpdConsent" style="font-size: 0.75rem;">Aceito os Termos e Pol√≠tica de
                                    Privacidade.</label>
                            </div>

                            <button type="submit" class="az-btn-main" style="width: 100%; margin-top: 1rem;"
                                id="submitBtnStories">
                                Gerar N√∫meros
                            </button>
                        </form>
                    </div>
                </div>
                <!-- SLIDE 2: Reveal -->
                <div class="story-slide" id="slideReveal">
                    <div class="story-badge">2</div>
                    <div class="story-header">
                        <h2 class="az-title" style="font-size: 1.5rem; margin-bottom: 0.5rem;">Esse s√£o seus n√∫meros da
                            sorte üçÄ</h2>
                        <p id="revealStatus" style="color: #aaa; margin: 0;">Boa sorte!</p>
                    </div>
                    <div class="story-content-area">
                        <div id="revealGrid" class="az-reveal-grid">
                            <!-- Grid populated by JS -->
                        </div>
                        <p style="color: #666; font-size: 0.8rem; margin-top: 2rem;" id="revealHint"></p>
                    </div>
                </div>
                <!-- SLIDE 3: Success -->
                <div class="story-slide" id="slideSuccess">
                    <div class="story-badge">3</div>
                    <div class="story-header">
                        <h2 class="az-title" style="font-size: 1.8rem; margin-bottom: 0.5rem;">√öltimo Passo</h2>
                        <p style="color: #aaa; margin: 0;">N√∫meros registrados</p>
                    </div>
                    <div class="story-content-area">
                        <div
                            style="background: rgba(0,230,118,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; width: 100%;">
                            <p style="margin: 0; color: #FFD700; font-size: 1rem; font-weight: bold;">‚ö†Ô∏è ENTRADA
                                OBRIGAT√ìRIA NO GRUPO OFICIAL DO SORTEIO PARA:</p>
                            <ul
                                style="margin: 1rem 0 0 0; padding-left: 1.2rem; color: #fff; font-size: 0.9rem; line-height: 1.6;">
                                <li>Ver resultado do Sorteio</li>
                                <li>Conquistar + n√∫meros da sorte</li>
                                <li>Receber avisos e atualiza√ß√µes importantes</li>
                            </ul>
                        </div>
                        <a href="#" id="groupLinkBtn" target="_blank" class="az-btn-main" onclick="finishFlow()"
                            style="width: 100%; margin-bottom: 1rem;">ENTRAR NO GRUPO</a>
                        <button class="az-btn-main az-btn-secondary" onclick="finishFlow()" style="width: 100%;">J√Å
                            ESTOU NO GRUPO</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sold Out Modal -->
    <!-- Sold Out Modal -->
    <div class="az-modal-overlay" id="soldOutModal" style="display: none;">
        <div class="az-modal"
            style="max-width: 400px; text-align: center; border: 1px solid #333; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
            <div id="soldOutEmoji" style="font-size: 3.5rem; margin-bottom: 0.5rem;">üò±</div>
            <h3 class="az-title" style="color: #f44336; margin-bottom: 0.5rem; font-size: 1.5rem;">ACABARAM OS
                N√öMEROS!</h3>
            <p style="color: #ccc; margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.4;">
                Poxa, todos os n√∫meros desta campanha j√° foram resgatados ou o sorteio foi encerrado.
            </p>

            <div
                style="background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                <p style="color: #25D366; font-weight: 800; margin-bottom: 0.3rem; font-size: 0.9rem;">N√ÉO FIQUE DE FORA
                    DO PR√ìXIMO!</p>
                <p style="font-size: 0.85rem; color: #eee; margin: 0;">Entre no nosso Grupo VIP e garanta seu n√∫mero
                    assim que
                    liberar:</p>
            </div>

            <a href="#" id="groupLinkSoldOut" target="_blank" class="az-btn-main"
                onclick="window.open(shareSettings.group_link, '_blank'); return false;"
                style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 0.8rem;">
                <span>üì±</span> ENTRAR NO GRUPO
            </a>

            <button class="az-btn-main az-btn-secondary" onclick="closeSoldOutModal()" style="width: 100%;">
                Fechar
            </button>
        </div>
    </div>

    <!-- Whitelist Error Modal -->
    <div class="az-modal-overlay" id="whitelistModal" style="display: none;">
        <div class="az-modal" style="max-width: 400px; text-align: center; border: 1px solid #333; padding: 2rem;">
            <!-- Warning Icon -->
            <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>

            <!-- Green Highlight Text -->
            <h2
                style="color: #10b981; font-weight: 900; font-size: 1.4rem; margin-bottom: 1rem; text-transform: uppercase;">
                ENTRE NO GRUPO PARA PARTICIPAR!
            </h2>

            <!-- Normal Text -->
            <p style="color: #ccc; font-size: 1rem; margin-bottom: 2rem; line-height: 1.5;">
                Seu n√∫mero n√£o est√° na lista de convidados.
            </p>

            <!-- Fixed WhatsApp Link Button -->
            <a href="https://chat.whatsapp.com/KsJ0XbrXvPg8FaNpaslVqc" target="_blank" class="az-btn-main"
                style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; text-decoration: none; font-weight:bold;">
                <span>üì±</span> ENTRAR NO GRUPO
            </a>

            <button class="az-btn-main az-btn-secondary"
                onclick="document.getElementById('whitelistModal').style.display='none'"
                style="width: 100%; margin-top: 1rem;">
                Fechar
            </button>
        </div>
    </div>

    <script>
        // State
        let claimSessionId = null;
        // Support both /p/TOKEN path and ?p=TOKEN query parameter
        let promoToken = new URLSearchParams(window.location.search).get('p');
        if (!promoToken && window.location.pathname.startsWith('/p/')) {
            promoToken = window.location.pathname.split('/p/')[1];
        }

        // Cloudinary URL optimization helper
        function optimizeCloudinaryUrl(url, options = {}) {
            if (!url || !url.includes('cloudinary.com')) return url;

            // Default optimizations: auto format and quality
            const transformations = options.transformations || 'q_auto,f_auto';

            // Insert transformations after /upload/
            if (url.includes('/upload/')) {
                return url.replace('/upload/', `/upload/${transformations}/`);
            }
            return url;
        }
        let deviceId = localStorage.getItem('az_device_id') || generateDeviceId();
        let shareSettings = {
            share_image: null, // No default image
            share_text: '',
            group_link: 'https://chat.whatsapp.com/KVfNKMR7W1lGMtMSWtN5W3'
        };

        // Promo-specific settings (overrides campaign settings when available)
        let promoSettings = null;

        // Stories State
        let currentStoryIndex = 0;
        const totalStories = 4;
        let step3Done = false;

        async function loadSettings() {
            try {
                const res = await fetch('/api/amigos/settings');
                if (!res.ok) throw new Error('Settings fetch failed');
                const text = await res.text();
                if (!text) throw new Error('Empty settings response');
                const data = JSON.parse(text);
                // Merge with defaults to preserve hardcoded links if DB is empty
                shareSettings = { ...shareSettings, ...data };

                if (shareSettings.share_image) document.getElementById('sharePreviewImg').src = shareSettings.share_image;
                if (shareSettings.group_link) document.getElementById('groupLinkBtn').href = shareSettings.group_link;
            } catch (e) { console.log('Using default settings:', e.message); }

            // If accessing via promo link, override share image with promo image/video
            if (promoToken) {
                try {
                    const promoRes = await fetch(`/api/amigos/promo/${promoToken}`);
                    if (promoRes.ok) {
                        const text = await promoRes.text();
                        if (text) {
                            const promoData = JSON.parse(text);

                            // Store promo settings for sharing
                            promoSettings = {
                                image_url: promoData.image_url,
                                share_text: promoData.share_text,
                                name: promoData.name,
                                sponsor_link: promoData.sponsor_link
                            };

                            if (promoData.image_url) {
                                const url = optimizeCloudinaryUrl(promoData.image_url);
                                const isVideo = url.match(/\.(mp4|mov|webm|avi)$/i) || url.includes('/video/');

                                if (isVideo) {
                                    document.getElementById('sharePreviewImg').style.display = 'none';
                                    const video = document.getElementById('sharePreviewVideo');
                                    video.src = url;
                                    video.style.display = 'block';
                                } else {
                                    document.getElementById('sharePreviewImg').src = url;
                                }
                            }

                            // Update slide 4: ALWAYS SHOW GROUP LINK (Reverted logic per user request)
                            // if (promoData.sponsor_link) { ... } -> Removed
                        }
                    }
                } catch (e) { console.log('Could not load promo media:', e.message); }
            }
        }
        loadSettings();

        // Update slide 4 to show sponsor link instead of group link
        function updateSlide4ForSponsor(sponsorLink, promoName) {
            const slide4 = document.getElementById('slideSuccess');
            if (!slide4) return;

            slide4.innerHTML = `
    <div class="story-badge">4</div>
    <div class="story-header">
        <h2 class="az-title" style="font-size: 1.8rem; margin-bottom: 0.5rem;">√öltimo Passo</h2>
        <p style="color: #aaa; margin: 0;">N√∫meros registrados</p>
    </div>
    <div class="story-content-area">
        <div
            style="background: rgba(0,230,118,0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; width: 100%;">
            <p style="margin: 0; color: #FFD700; font-size: 1rem; font-weight: bold;">üéÅ PROMO√á√ÉO: ${promoName ||
                'Especial'}</p>
            <p style="margin: 1rem 0 0 0; color: #fff; font-size: 0.9rem;">
                Clique no bot√£o abaixo para entrar em contato com o patrocinador desta promo√ß√£o
            </p>
        </div>
        <a href="${sponsorLink}" target="_blank" class="az-btn-main" onclick="finishFlow()"
            style="width: 100%; margin-bottom: 1rem;">FALAR COM PATROCINADOR</a>
        <button class="az-btn-main az-btn-secondary" onclick="finishFlow()" style="width: 100%;">CONTINUAR</button>
    </div>
    `;
        }

        function showAlert(message, title = 'Aten√ß√£o', callback = null) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
            window.alertCallback = callback;
        }

        function closeAlertModal() {
            document.getElementById('alertModal').style.display = 'none';
            if (window.alertCallback) {
                window.alertCallback();
                window.alertCallback = null;
            }
        }

        function generateDeviceId() {
            const id = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            localStorage.setItem('az_device_id', id);
            return id;
        }

        function maskPhone(input) {
            let digits = input.value.replace(/\D/g, '');
            if (digits.length > 11) digits = digits.substring(0, 11);

            let formatted = '';
            if (digits.length === 0) formatted = '';
            else if (digits.length <= 2) formatted = '(' + digits;
            else if (digits.length <= 7) formatted = '(' + digits.substring(0, 2) + ') ' + digits.substring(2);
            else formatted = '(' + digits.substring(0, 2) + ') ' + digits.substring(2, 7) + '-' + digits.substring(7);

            input.value = formatted;
        }

        function capitalizeName(name) {
            if (!name) return '';
            return name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        async function checkExistingUser(phone) {
            if (phone.length < 14) return;
            try {
                const res = await fetch(`/api/amigos/lookup?phone=${encodeURIComponent(phone)}`);
                if (!res.ok) return;
                const text = await res.text();
                if (!text) return;
                const data = JSON.parse(text);
                if (data.found && data.name) {
                    const nameInput = document.getElementById(' name'); if (nameInput && !nameInput.value) {
                        nameInput.value = capitalizeName(data.name);
                    }
                }
            } catch (e) { console.log('Lookup error:', e); }
        }

        // ---- Stories Nav Logic ----
        // ---- Stories Nav Logic ----
        function updateStories() {
            const track = document.getElementById('storiesTrack');
            track.style.transform = `translateX(-${currentStoryIndex * 33.333333}%)`;

            // Manage Next button (Arrow)
            let nextBtn = document.getElementById('storyNextBtn');
            nextBtn.classList.remove('visible'); // default hide

            // Step 1: Form (Index 0). Controlled by "Gerar N√∫meros" button. No Arrow.

            // Step 2: Reveal (Index 1).
            // Show arrow ONLY when reveal is done.
            if (currentStoryIndex === 1 && step3Done) { // step3Done variable holds the "reveal finished" state (I'll rename it in mind to 'stepRevealDone' but keeping var name to avoid breaking ref)
                nextBtn.classList.add('visible');
            }

            // Step 3: Success (Index 2). No next arrow.
        }

        function nextStory() {
            // Updated totalStories is effectively 3 visible slides now, but array length might still imply 4 if logic isn't careful.
            // But CSS translateX uses 25%? If we have fewer slides, we should adjust width or translateX.
            // Wait, HTML removed 1 slide. So we have 3 slides. 
            // Width of track? 
            // If we have 3 slides, translateX should be: 0%, -33.3%, -66.6%?
            // Or -100%, -200%?
            // The CSS for `stories-track` usually sets width: 400% if 4 slides.
            // I should check CSS. Assuming I need to update CSS or JS calculation.
            // Let's assume JS calculates based on count.

            if (currentStoryIndex < 3) { // Max index 2
                if (currentStoryIndex === 0) {
                    // Form Step (Now Index 0)
                    const form = document.getElementById('claimFormStories');
                    if (form.checkValidity()) {
                        document.getElementById('submitBtnStories').click();
                    } else {
                        form.reportValidity();
                    }
                    return;
                }
                currentStoryIndex++;
                updateStories();
            }
        }

        function closeStories() {
            document.getElementById('storiesView').style.display = 'none';
            document.getElementById('home-view').style.display = 'block'; // Show home
            if (currentStoryIndex === 2) { // Success Step (Index 2)
                window.location.reload();
            }
        }

        // ---- Flow Functions ----

        async function startFlow() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'Carregando...';

            try {
                const res = await fetch('/api/amigos/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ promo_token: promoToken, device_id: deviceId })
                });

                // Check response before parsing
                if (!res.ok) {
                    const errorText = await res.text();
                    let errorMsg = 'Erro ao iniciar';
                    try {
                        const errJson = JSON.parse(errorText);
                        errorMsg = errJson.error || errorMsg;
                    } catch { errorMsg = errorText || errorMsg; }
                    throw new Error(errorMsg);
                }

                const data = await res.json();
                claimSessionId = data.claim_session_id;

                // SWITCH VIEW (No Modal)
                document.getElementById('home-view').style.display = 'none';
                document.getElementById('storiesView').style.display = 'flex';

                currentStoryIndex = 0;
                updateStories();

                const savedPhone = localStorage.getItem('az_phone');
                if (savedPhone) {
                    document.getElementById('phone').value = savedPhone;
                    checkExistingUser(savedPhone);
                }

                btn.disabled = false;
                btn.textContent = 'Resgatar N√∫mero';
            } catch (e) {
                // SOLD OUT / LIMIT STRATEGY
                const msg = e.message.toLowerCase();
                if (msg.includes('esgotados') || msg.includes('campanha') || msg.includes('encerrada')) {
                    showSoldOutModal('sold_out');
                } else if (msg.includes('resgatou') || msg.includes('hoje') || msg.includes('limite')) {
                    showSoldOutModal('daily_limit');
                } else {
                    showAlert(e.message, 'Erro');
                }

                btn.disabled = false;
                btn.textContent = 'Resgatar N√∫mero';
            }
        }

        function showSoldOutModal(type = 'sold_out') {
            const modal = document.getElementById('soldOutModal');
            const title = modal.querySelector('h3');
            const desc = modal.querySelector('p');
            const emoji = document.getElementById('soldOutEmoji');

            if (type === 'daily_limit') {
                emoji.textContent = 'üìÖ';
                title.textContent = 'VOC√ä J√Å PARTICIPOU HOJE!';
                desc.innerHTML = 'Voc√™ j√° garantiu seus n√∫meros de hoje.<br>Volte amanh√£ para pegar mais!';
            } else {
                emoji.textContent = 'üò±';
                title.textContent = 'ACABARAM OS N√öMEROS!';
                desc.textContent = 'Poxa, todos os n√∫meros desta campanha j√° foram resgatados ou o sorteio foi encerrado.';
            }

            modal.style.display = 'flex';
        }
        function closeSoldOutModal() {
            document.getElementById('soldOutModal').style.display = 'none';
        }

        // Dead code removed (shareToWhatsApp)

        function maskPhone(input) {
            let v = input.value.replace(/\D/g, "");
            if (v.length > 11) v = v.substring(0, 11);
            if (v.length > 10) {
                input.value = `(${v.substring(0, 2)}) ${v.substring(2, 7)}-${v.substring(7)}`;
            } else if (v.length > 5) {
                input.value = `(${v.substring(0, 2)}) ${v.substring(2, 6)}-${v.substring(6)}`;
            } else if (v.length > 2) {
                input.value = `(${v.substring(0, 2)}) ${v.substring(2)}`;
            } else {
                input.value = v;
            }
        }

        function maskCEP(input) {
            let v = input.value.replace(/\D/g, "");
            if (v.length > 8) v = v.substring(0, 8);
            if (v.length > 5) {
                input.value = `${v.substring(0, 5)}-${v.substring(5)}`;
            } else {
                input.value = v;
            }
        }

        async function submitClaimStep2(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtnStories');
            const originalText = btn.textContent; // Fix: Define originalText
            const phone = document.getElementById('phone').value;
            const name = document.getElementById('name').value;
            const shared = document.getElementById('sharedStatus').value;
            const cep = document.getElementById('cep').value; // Get CEP

            if (!phone || phone.length < 14) {
                return alert('Por favor, preencha um WhatsApp v√°lido (DDD + N√∫mero).');
            }
            if (!name || name.trim().split(' ').length < 2) {
                return alert('Digite seu Nome Completo (Nome e Sobrenome).');
            }
            if (cep.length < 9) {
                return alert('Por favor, preencha o CEP completo (00000-000).');
            }
            if (!shared) {
                return alert('Informe se voc√™ j√° compartilhou no status.');
            }

            btn.classList.add('loading');
            btn.disabled = true;

            try {
                // Tracking Consent
                const consent = document.getElementById('lgpdConsent').checked;

                const res = await fetch('/api/amigos/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        claim_session_id: claimSessionId, // Match backend snake_case
                        phone,
                        name: name.trim(),
                        lgpd_consent: consent, // Match backend key
                        promo_token: promoToken, // Match backend snake_case
                        ua: navigator.userAgent,
                        device_id: deviceId,
                        cep: cep
                    })
                });

                const result = await res.json();
                if (!res.ok) throw new Error(result.error || 'Erro ao finalizar');

                currentStoryIndex = 1; // FIX: Advance to Reveal Slide
                updateStories();
                revealNumbers(result.numbers);

                btn.disabled = false;
                btn.textContent = originalText;
            } catch (err) {
                // SOLD OUT / LIMIT STRATEGY: Also catch here in Step 2
                const msg = err.message.toLowerCase();
                if (msg.includes('esgotados') || msg.includes('campanha') || msg.includes('encerrada')) {
                    showSoldOutModal('sold_out');
                } else if (msg.includes('resgatou') || msg.includes('hoje') || msg.includes('limite')) {
                    showSoldOutModal('daily_limit');
                } else if (msg.includes('entre no grupo')) {
                    // NEW: Specific Whitelist Modal
                    document.getElementById('whitelistModal').style.display = 'flex';
                } else {
                    showAlert(err.message, 'Erro');
                }

                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function revealNumbers(numbers) {
            const sorted = numbers.sort((a, b) => a - b);
            const grid = document.getElementById('revealGrid');
            grid.innerHTML = '';

            // Random String Gen
            function randomStr() { return Math.floor(Math.random() * 10000).toString().padStart(4, '0'); }

            // Populate initially with random (hidden for pop-in)
            sorted.forEach((num, i) => {
                const card = document.createElement('div');
                card.className = 'az-card blur';
                card.id = `reveal-card-${i}`;
                card.style.opacity = '0'; // Start hidden for pop-in
                card.innerHTML = `<div class="az-card-content">${randomStr()}</div>`;
                grid.appendChild(card);

                // Pop-in animation with stagger
                setTimeout(() => {
                    card.classList.add('pop-in');
                    card.style.opacity = '1';
                }, i * 100);
            });

            // Iterate Lines
            const linesCount = Math.ceil(sorted.length / 5);
            let currentLine = 0;

            function revealLine() {
                if (currentLine >= linesCount) {
                    document.getElementById('revealStatus').textContent = 'Boa sorte!';
                    step3Done = true;
                    updateStories();
                    document.getElementById('revealHint').textContent = 'Toque na seta para continuar >';
                    return;
                }
                const startIdx = currentLine * 5;
                const endIdx = Math.min(startIdx + 5, sorted.length);

                // Animate each card in line
                for (let i = startIdx; i < endIdx; i++) {
                    // Stagger start 
                    setTimeout(() => {
                        const card = document.getElementById(`reveal-card-${i}`);
                        const targetNum = sorted[i].toString().padStart(4, '0');
                        const content = card.querySelector('.az-card-content');

                        card.classList.remove('blur');
                        card.style.border = '2px solid var(--az-primary)';

                        let cycles = 0;
                        let speed = 50;
                        const maxCycles = 15 + Math.floor(Math.random() * 10);

                        function spin() {
                            content.textContent = randomStr();
                            cycles++;

                            if (cycles < maxCycles) {
                                if (cycles > maxCycles - 5) speed += 30; // Slow down
                                setTimeout(spin, speed);
                            } else {
                                // Stop
                                content.textContent = targetNum;
                                card.classList.add('slot-revealed');
                            }
                        }
                        spin();
                    }, (i - startIdx) * 100);
                }

                currentLine++;
                // Next line delay
                setTimeout(revealLine, 1200);
            }
            setTimeout(revealLine, 300);
        }

        function finishFlow() {
            window.location.reload();
        }

        function handleBlocked(msg) {
            showAlert(msg, 'Bloqueado', () => window.location.reload());
            closeStories();
        }

        function openLookupModal() { document.getElementById('lookupModal').style.display = 'flex'; }
        function closeLookupModal() { document.getElementById('lookupModal').style.display = 'none'; }

        async function doLookup() {
            const phone = document.getElementById('lookupPhoneModal').value;
            const resultEl = document.getElementById('lookupResultModal');
            if (!phone || phone.length < 14) {
                resultEl.innerHTML = '<p style="color: #f44336;">Digite um telefone v√°lido.</p>'; return;
            }
            resultEl.innerHTML = '<p style="color: #aaa;">Buscando...</p>';
            fetch(`/api/amigos/lookup?phone=${encodeURIComponent(phone)}`).then(r => r.json())
                .then(data => {
                    if (!data.found) {
                        resultEl.innerHTML = '<p style="color: #ff9800;">Nenhum n√∫mero encontrado.</p>';
                        return;
                    }
                    const sorted = data.numbers.sort((a, b) => a - b);

                    // Generate HTML with pop-in animation (starts hidden)
                    const numsHtml = sorted.map((n, i) =>
                        `<div class="az-card slot-revealed"
                        style="opacity:0; border: 2px solid var(--az-primary); aspect-ratio:1; font-size: 0.7rem; animation-delay: ${i * 100}ms;"
                        data-pop-delay="${i * 100}">
                        <div class="az-card-content">${String(n).padStart(4, '0')}</div>
                    </div>`
                    ).join('');

                    resultEl.innerHTML = `<div
                        style="background: rgba(0,230,118,0.1); padding: 15px; border-radius: 8px;">
                        <p style="color:white; margin-bottom: 1rem;">Ol√° <strong>${data.name}</strong>, voc√™ tem
                            ${data.total_numbers} n√∫meros:</p>
                        <div class="az-reveal-grid" style="max-width: 100%;">
                            ${numsHtml}
                        </div>
                    </div>`;

                    // Trigger pop-in animation with stagger
                    const cards = resultEl.querySelectorAll('.az-card');
                    cards.forEach((card, i) => {
                        setTimeout(() => {
                            card.classList.add('pop-in');
                            card.style.opacity = '1';
                        }, i * 100);
                    });
                })
                .catch(() => { resultEl.innerHTML = '<p style="color: #f44336;">Erro ao buscar.</p>'; });
        }

        function animatePlaceholders() {
            const container = document.getElementById('cardsContainer');
            const cards = Array.from(container.querySelectorAll('.az-card'));
            function randomNumber() { return Math.floor(Math.random() * 10000).toString().padStart(4, '0'); }

            // First: Pop-in animation (cards appear one by one)
            cards.forEach((card, i) => {
                card.style.opacity = '0';
                setTimeout(() => {
                    card.classList.add('pop-in');
                    card.style.opacity = '1';
                }, i * 150); // 150ms stagger
            });

            function animateCard(card, delay) {
                const content = card.querySelector('.az-card-content');
                let speed = 50;
                let cycles = 0;
                const maxCycles = 15 + Math.floor(Math.random() * 10);

                function spin() {
                    content.textContent = randomNumber();
                    cycles++;
                    if (cycles < 5) speed = 50; else if (cycles < maxCycles - 5) speed = 80; else if (cycles < maxCycles)
                        speed = 150 + (cycles - maxCycles + 5) * 30; else {
                        cycles = 0; speed = 50; setTimeout(spin, 800 +
                            Math.random() * 500); return;
                    } setTimeout(spin, speed);
                } setTimeout(spin, delay);
            }
            // Start slot animation after pop-in completes
            setTimeout(() => {
                cards.forEach((card, i) => animateCard(card, i * 200));
            }, cards.length * 150 + 300);
        }
        animatePlaceholders();

        // Safety Init
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('generateBtn');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Resgatar N√∫mero';
            }
        });

    </script>

    <!-- IDSR Footer -->
    <footer class="idsr-footer">
        <div class="idsr-footer-content">
            <span class="idsr-footer-text">¬© 2026 IDSR. Todos os direitos reservados.</span>
            <span class="idsr-separator">|</span>
            <a href="https://idsr.com.br" target="_blank" rel="noopener noreferrer" class="idsr-link">
                Produzido e gerenciado por <strong>IDSR</strong>
            </a>
        </div>
    </footer>

    <style>
        .idsr-footer {
            width: 100%;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.05);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 40px;
            text-align: center;
        }

        .idsr-footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.75rem;
            color: #666;
        }

        .idsr-footer-text {
            opacity: 0.7;
        }

        .idsr-separator {
            opacity: 0.3;
        }

        .idsr-link {
            color: #666;
            text-decoration: none;
            transition: all 0.2s ease;
            opacity: 0.8;
        }

        .idsr-link:hover {
            color: #000;
            opacity: 1;
        }

        .idsr-link strong {
            font-weight: 600;
            color: #d4af37;
        }

        @media (max-width: 600px) {
            .idsr-footer-content {
                font-size: 0.7rem;
                flex-direction: column;
                gap: 4px;
            }

            .idsr-separator {
                display: none;
            }
        }
    </style>

</body>

</html>